<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Status</title>
    <link rel="icon" href="https://emoji.gg/assets/emoji/4071-monitoring.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        /* Color for a green 'Online' segment in the history bar */
        .segment-up { background-color: #238636; } 
        /* Color for a grey 'Down' or 'No Data' segment */
        .segment-down { background-color: #30363d; }
    </style>
</head>
<body class="text-gray-200">
    <div class="container mx-auto max-w-4xl px-4 py-12">
        <header class="mb-10">
            <h1 class="text-4xl font-bold text-white text-center">System Status</h1>
            <p id="overall-status" class="text-center text-lg text-gray-400 mt-2">Loading status...</p>
        </header>

        <main id="services-container" class="space-y-6">
            <!-- JavaScript will generate the status cards here -->
        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Last updated on <span id="last-updated">...</span>.</p>
        </footer>
    </div>

    <script>
    // This MUST match the 'history_segments' value in your config.yaml
    const HISTORY_SEGMENTS = 48; 

    async function updateStatus() {
        try {
            const response = await fetch('/status');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();

            // Update the main status message at the top
            document.getElementById('overall-status').textContent = data.overall_status;
            
            // Update the footer timestamp
            const date = new Date();
            document.getElementById('last-updated').textContent = date.toLocaleString('en-US', {
                dateStyle: 'full', timeStyle: 'medium' 
            });

            const container = document.getElementById('services-container');
            container.innerHTML = ''; // Clear old cards

            // Loop through each service from the API data
            for (const site of data.sites) {
                
                // --- This loop builds the visual history bar ---
                let historyBarHtml = '';
                for (let i = 0; i < HISTORY_SEGMENTS; i++) {
                    const check = site.history[i];
                    const statusClass = check && check.status === 'Online' ? 'segment-up' : 'segment-down';
                    const tooltip = check ? `${check.status} at ${new Date(check.timestamp * 1000).toLocaleTimeString()}` : 'No data';
                    historyBarHtml += `<div class="h-full w-full rounded-sm ${statusClass}" title="${tooltip}"></div>`;
                }

                // --- This is the HTML for a single service card ---
                const cardHtml = `
                <div class="bg-[#161b22] border border-[#30363d] rounded-lg p-5">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xl font-semibold text-white">${site.name}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-xl font-mono text-gray-300">${site.uptime_percent_90d}</span>
                            <span class="flex items-center justify-center h-7 w-7 rounded-full bg-green-500/20">
                                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                            </span>
                        </div>
                    </div>
                    <!-- The history bar is a CSS grid with 48 columns -->
                    <div class="h-8 w-full grid grid-cols-48 gap-1.5">
                        ${historyBarHtml}
                    </div>
                </div>
                `;
                // Add the new card to the page
                container.innerHTML += cardHtml;
            }

        } catch (error) {
            console.error("Failed to fetch status:", error);
            document.getElementById('overall-status').textContent = "Could not load status data.";
        }
    }
    
    // Refresh the data periodically. This should match your check_interval.
    // 1800 * 1000 milliseconds = 30 minutes.
    setInterval(updateStatus, 1800 * 1000); 

    // Run once when the page first loads
    document.addEventListener('DOMContentLoaded', updateStatus);
    </script>
</body>
</html>

